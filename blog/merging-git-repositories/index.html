<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!-->
<html class="no-js" lang="en"><!--<![endif]-->

<head>
  <meta charset="utf-8">

  <title>Join two Git repositories and keep the original commit dates. - axiac@web</title>
  <meta name="author" content="axiac">


  <meta name="description" content="Several years ago I started a project that was stored in a Subversion repository. After
some time, the current (at that time) version of the code was &hellip;">


  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <link rel="canonical" href="http://axiac.github.io/blog/merging-git-repositories/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="axiac@web" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js" async></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript" async></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <script>
      (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
          (i[r].q = i[r].q || []).push(arguments);
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
          m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m);
      })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-545821-11', 'axiac.ro');
    if (navigator.userAgent.indexOf('axiac') == -1) {
      ga('send', 'pageview');
    }
  </script>






  <meta property="fb:app_id" content="128516770538860" />


  <meta property="og:url" content="http://axiac.github.io/blog/merging-git-repositories/" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Join two Git repositories and keep the original commit dates. - axiac@web" />
  <meta property="og:description" content="Several years ago I started a project that was stored in a Subversion repository. After
some time, the current (at that time) version of the code was used to create a new Git
repository and the development continued. Several months and hundreds of commits later,
I decided to gather the code from &hellip;" />
  <meta property="og:image" content="http://axiac.github.io/favicon.png" />

  <meta property="og:author" content="https://www.facebook.com/axiac.ro/" />



</head>

<body>
  <header role="banner">
    <hgroup>
      <h1><a href="/">axiac@web</a></h1>

    </hgroup>

  </header>
  <nav role="navigation">
    <ul class="subscription" data-subscription="rss">
      <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>

    </ul>

    <form action="https://www.google.com/search" method="get">
      <fieldset role="search">
        <input type="hidden" name="q" value="site:axiac.ro" />
        <input class="search" type="text" name="q" results="0" placeholder="Search" />
      </fieldset>
    </form>

    <ul class="main-navigation">
      <li><a href="/">Blog</a></li>
      <li><a href="/blog/archives">Archives</a></li>
    </ul>

  </nav>
  <div id="main">
    <div id="content">
      <div>
        <article class="hentry" role="article">

          <header>


            <h1 class="entry-title">Join two Git repositories and keep the original commit dates.</h1>


            <p class="meta">





              <time class='updated' datetime='2014-11-17'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>17</span><span
                    class='date-suffix'>th</span>, <span class='date-year'>2014</span></span></time>

            </p>

          </header>


          <div class="entry-content">
            <p>Several years ago I started a project that was stored in a Subversion repository. After
              some time, the current (at that time) version of the code was used to create a new Git
              repository and the development continued. Several months and hundreds of commits later,
              I decided to gather the code from both repositories into a single repository and keep all
              the historical data intact.</p>

            <p>The goal was to get all the code since the project started until the most recent version
              into a single Git repository as we have used Git from the project beginning.</p>

            <p>I&rsquo;ll explain below how to accomplish this goal.</p>

            <!-- more -->


            <p>I started by using <a href="http://subgit.com">SubGit</a> to import the Subversion commits into a new Git repository.
              I could do the import with <code>git svn</code> but SubGit does a better job.</p>

            <h2>The request</h2>

            <p>In a graphical fashion, the starting setup looks like this:</p>

            <pre><code> o &lt;- second-head, second-master    \
 |                                   |
 o                                   |
/|\                                  |
...                                  | 'second-repo', the newest code
\|/                                  |
 o                                   |
 |                                   |
 o &lt;- second-root                   /
 .
 . &lt;-- the desired link (it does not exist now)
 .
 o &lt;- first-head, first-master      \
 |                                   |
 o                                   |
/|\                                  | 'first-repo', the oldest code
...                                  |
\|/                                  |
 o                                  /
</code></pre>

            <p>We want to create a link between commits <code>first-head</code> and <code>second-root</code> (make <code>first-head</code> the parent of
              <code>second-root</code>) and:
            </p>

            <ul>
              <li>preserve the code changes and author date and email of each commit imported from <code>second-repo</code>;</li>
              <li>preserve the commit times of the commits imported from <code>second-repo</code>;</li>
              <li>preserve the branches and merges from <code>second-repo</code>.</li>
            </ul>


            <p>The first goal is automatically achieved by <code>git rebase</code>. It does not change the content of the commits
              it handles and it is very carefully with the authors information too.</p>

            <p>In theory, all we need to do is:</p>

            <pre><code>$ git rebase first-head second-head
</code></pre>

            <p>We&rsquo;ll discover that, while it copies the commits from the second repository on top of <code>first-head</code>, it
              makes the history linear (flattens the branches and merges) and it sets the <code>committer date</code> of all the
              copied commits to the current date&amp;time. It does not comply with our second and third items from the list
              above.</p>

            <p>Paying more attention to <code>git help rebase</code>, we&rsquo;ll discover that adding the option <code>--committer-date-is-author-date</code>
              tells <code>git</code> to copy the <code>author date</code> as <code>committer date</code> for the commits it handles. While this still
              does not preserve the original commit dates, it is however pretty useful. Usually the <code>committer date</code> is
              the same as <code>author date</code>. They do not match for amended commits, rebased commits and commits submitted
              as patches through email. We could live with that but it still does not match the third item from our list.
              And it is an important one because the past branches and merges shape the history of the code base.</p>

            <p>Looking more thoroughly into the help, we&rsquo;ll discover the option <code>--preserve-merges</code> that helps <code>git</code>
              accomplish our third goal. The branches and merges are replicated correctly but, unfortunately, the
              commit dates are again set to the current date&amp;time.</p>

            <h4>What&rsquo;s wrong?</h4>

            <p>Nothing is wrong. The help explains: <code>--preserve-merges</code> internally uses the
              <code>--interactive</code> machinery and <code>--committer-date-is-author-date</code> is incompatible with <code>--interactive</code>.
            </p>

            <p>Apparently this is a dead end.</p>

            <h3>Really?</h3>

            <p>I did some research on the Internet and I found a partial solution in an <a href="http://stackoverflow.com/a/19522951/4265352">answer</a>
              on StackOverflow. It is not completely baked, it even fails with a syntax error, but it helped me
              to find the right path and the complete solution.</p>

            <h2>My solution</h2>

            <p>The solution involves several steps:</p>

            <ul>
              <li>prepare a new working repository; get all the required commits into it and mark the important
                ones with branches;</li>
              <li>create the missing link between <code>first-head</code> and <code>second-root</code>; force its creation as Git will,
                most probably, complain;</li>
              <li>rebase the other commits between <code>second-root</code> and <code>second-head</code>;</li>
              <li>fix the <code>committer date</code> for all the commits affected by the previous two steps;</li>
              <li>cleanup.</li>
            </ul>


            <h3>Preparations</h3>

            <p>Let&rsquo;s start with the first repository (the older code) in <code>./first-repo</code> and the second repository
              (the newer code) in <code>./second-repo</code>.</p>

            <p>Let&rsquo;s create a new repository in <code>./merge-repo</code> and do all the work there. We&rsquo;ll clone the first
              repository, add the second one as a remote and fetch its commits.</p>

            <pre><code>$ mkdir ./merge-repo
$ cd ./merge-repo
$ git clone ../first-repo .
$ git remote add second-repo ../second-repo
$ git fetch second-repo
</code></pre>

            <p>Next we&rsquo;ll create some branches to point at some special commits: the first and the last commits
              from the second repository:</p>

            <pre><code>$ git branch second-head second-repo/master
$ git branch second-root $(git log second-head --reverse --pretty=%H | head -n 1)
</code></pre>

            <p>The most recent commit of the first repository (this is where we will link <code>second-root</code>):</p>

            <pre><code>$ git branch first-head master
</code></pre>

            <p>We&rsquo;ll rename the <code>master</code> branch (it points to the most recent commit of the first repository) to
              <code>first-head</code>. We will create another <code>master</code> branch after everything is completed.
            </p>

            <pre><code>$ git branch -m master first-master
$ git branch second-master second-repo/master
</code></pre>

            <p>Finally, we remove all the remotes to keep the working repository isolated.</p>

            <pre><code>$ git remote remove origin
$ git remote remove second-repo
</code></pre>

            <p>This way, if something goes wrong we can just remove the <code>./merge-repo</code> directory and start over.</p>

            <h3>Backup the commit dates</h3>

            <p>Save the tree hash and the commit time (Unix timestamp) of the commits from the second repository
              to a file. We&rsquo;ll use these to restore the original commit times after the rebase. The tree hash is used
              to identify each commit. We could also save the commit hashes to the file but they are of no use because
              they change after the rebase. However, the tree hashes do not change because the rebase does not modify
              the content of the affected commits, only their parents and commit time.</p>

            <pre><code>$ git log --pretty='%T %ct' ..second-head &gt; /tmp/hashlist
</code></pre>

            <h3>Make <code>first-head</code> the parent of <code>second-root</code></h3>

            <p>Since we are happy with the files from both repositories and just want to paste <code>second-root</code> on top of
              <code>first-head</code>, any potential conflict must be resolved using the files from the applied commit (<code>second-root</code>):
            </p>

            <pre><code>$ git cherry-pick --strategy-option=theirs second-root
</code></pre>

            <p>This forces <code>git</code> to apply <code>second-root</code> on top of <code>first-head</code> and use the information from
              <code>second-root</code>
              to solve any conflict that appears.</p>

            <h3>Copy the rest of the commits from the second repository</h3>

            <p>Try the rebase:</p>

            <pre><code>$ git rebase --preserve-merges --onto first-head --root second-head
</code></pre>

            <p>It will stop with an error like this:</p>

            <pre><code>$ git rebase --preserve-merges --onto first-head --root second-head
The previous cherry-pick is now empty, possibly due to conflict resolution.
If you wish to commit it anyway, use:

    git commit --allow-empty

Otherwise, please use 'git reset'
rebase in progress; onto cffbb1c
You are currently rebasing branch 'second-head' on 'cffbb1c'.

nothing to commit, working directory clean
Could not pick 1f7f7036025ac1d48973818b1602fc9aa91731fb
</code></pre>

            <p>It basically complains that it cannot find any difference between <code>second-root</code> and <code>first-head</code>
              and it is entirely right; using the previous <code>cherry-pick</code> we just applied the commit <code>second-root</code>
              on top of the original <code>first-head</code> and now <code>first-head</code> looks identical with <code>second-root</code>.</p>

            <p>Let&rsquo;s just tell Git to ignore this commit and continue:</p>

            <pre><code>$ git rebase --skip
</code></pre>

            <p>This would take a while (depending on the size of your second repository) and it should complete successfully.
              If it fails then you are on your own. But it has no reason to fail.</p>

            <h3>Fix the committer dates</h3>

            <p>The <code>rebase</code> operation keeps most of the meta-data of the commits it changes. It changes the commit hash,
              of course, and it also changes the committer date (using the current date). We want to keep the original
              committer date (this is the entire point of this article after all).</p>

            <p>We can &ldquo;fix&rdquo; the original committer dates using a bit of magic:</p>

            <pre><code>$ git filter-branch --env-filter 'export GIT_COMMITTER_DATE=$(fgrep -m 1 $(git log -1 --pretty=%T $GIT_COMMIT) /tmp/hashlist | cut -d" " -f2)' first-master..second-head
</code></pre>

            <p>In plain English, <code>git filter-branch</code> lets you rewrite Git revision history by applying custom filter
              on each revision. Our custom filter identifies the commit to be changed by its tree hash, finds the
              corresponding commit date into the backup file we created earlier and uses the <code>$GIT_COMMITTER_DATE</code>
              environment variable to set the desired <code>committer date</code> to the commit being processed.</p>

            <h4>If something goes wrong</h4>

            <p>The previous position of the <code>second-head</code> branch can be found in the file
              <code>.git/refs/original/refs/heads/master</code>
            </p>

            <pre><code>$ cat .git/refs/original/refs/heads/second-head
</code></pre>

            <p>To revert the <code>git filter-branch</code>:</p>

            <pre><code>$ git reset --hard $(cat .git/refs/original/refs/heads/second-head)
</code></pre>

            <p>Before trying to <code>git filter-branch</code> again, the backup ref file must be deleted (<code>filter-branch</code> refuses
              to run if it founds it):</p>

            <pre><code>$ rm .git/refs/original/refs/heads/second-head
</code></pre>

            <h3>Cleanup</h3>

            <p>After the successful linking, the current branch is <code>second-head</code> and we have some branches pointing
              to various commits involved in the process. We can rename <code>second-head</code> to <code>master</code> and remove the other branches.</p>

            <pre><code>$ git branch -m second-head master
$ git branch -D first-head
$ git branch -D second-root
$ git branch -D second-master
$ rm .git/refs/original/refs/heads/second-head
</code></pre>

            <p>The branch <code>first-master</code> is still there, pointing to the <code>master</code> branch of the first repository. You may
              probably want to keep it as reference (or, better, create a tag pointing on that commit.)</p>

            <p>Remove the hash file:</p>

            <pre><code>$ rm /tmp/hashlist
</code></pre>

            <h2>Remarks</h2>

            <ul>
              <li>
                <p>Only the current branch from the new repository will be appended to the old repository; any dangling branch
                  needs to be rebased individually after the process completes; the same technique could work, given the
                  join points are set up correctly.</p>
              </li>
              <li>
                <p>Extras from <code>git help filter-branch</code>:</p>

                <blockquote>
                  <p>Note that since this operation is very I/O expensive, it might be a good idea to redirect the temporary
                    directory off-disk with the -d option, e.g. on tmpfs.
                    Reportedly the speedup is very noticeable.</p>
                </blockquote>

                <p>It took a couple of seconds for me, for about 2,500 commits but it is not relevant because my repository
                  was stored on a SSD.</p>
              </li>
              <li>
                <p>Because of the rebase, <strong>ALL</strong> the commits from the newer repository changed their hashes. If the
                  repository is published this will puzzle the other contributors. <em>Before attempting this stunt, make sure
                    that all the important branches are merged, everybody knows what&rsquo;s going on and how to catch up and
                    continue afterwards without losing their work</em>.</p>

                <p><strong>You have been warned!</strong></p>
              </li>
            </ul>

          </div>


          <footer>
            <p class="meta">



              <span class="byline author vcard">Posted by <span class="fn">axiac</span></span>






              <time class='updated' datetime='2014-11-17'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>17</span><span
                    class='date-suffix'>th</span>, <span class='date-year'>2014</span></span></time>


              <span class="categories">

                <a class='category' href='/blog/categories/git/'>git</a>

              </span>


            </p>

            <div class="sharing">

              <a href="//twitter.com/share" class="twitter-share-button" data-url="http://axiac.github.io/blog/merging-git-repositories/" data-via="axiac"
                data-counturl="http://axiac.github.io/blog/merging-git-repositories/">Tweet</a>


              <div class="g-plusone" data-size="medium"></div>


              <div class="fb-like" data-share="true" data-width="450" data-show-faces="false"></div>

            </div>


            <div class="fb-comments" data-href="http://axiac.github.io/blog/merging-git-repositories/" data-numposts="5" data-width="789"></div>



            <p class="meta">

              <a class="basic-alignment left" href="/blog/sa-se-afle-ultimele-4-cifre-ale-numarului/"
                title="Previous Post: Să se afle ultimele 4 cifre ale numărului">&laquo; Să se afle ultimele 4 cifre ale numărului</a>


              <a class="basic-alignment right" href="/blog/dont-forget-to-clone-the-datetime-objects/" title="Next Post: Do you clone the DateTime objects?">Do
                you clone the DateTime objects? &raquo;</a>

            </p>
          </footer>
        </article>

        <section>
          <h1>Comments</h1>
          <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered
                by Disqus.</a></noscript>
          </div>
        </section>

      </div>

      <aside class="sidebar">

        <section>
          <h1>Recent Posts</h1>
          <ul id="recent_posts">


            <li class="post">
              <a href="/blog/why-is-mysql-time-limited-to-838-59-59/">Why Is MySQL Time Limited to 838:59:59?</a>
            </li>


            <li class="post">
              <a href="/blog/git-ignores-me-not-my-files/">Git Ignores Me, Not My Files</a>
            </li>


            <li class="post">
              <a href="/blog/how-to-merge-composer-files/">How to Merge Composer Files</a>
            </li>


            <li class="post">
              <a href="/blog/public-properties-are-not-oop/">Public Properties Are Not OOP</a>
            </li>


            <li class="post">
              <a href="/blog/atlassian-sourcetree-and-git-hooks/">Atlassian SourceTree and Git hooks</a>
            </li>

          </ul>
        </section>



        <section class="googleplus googleplus-hidden">
          <h1>
            <a href="https://plus.google.com/116025233500446558681?rel=author">
              <img src="//www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
              Google+
            </a>
          </h1>
        </section>




      </aside>


    </div>
  </div>
  <footer role="contentinfo">
    <p>
      Copyright &copy; 2013-2020 - axiac -
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
    </p>

  </footer>


  <script type="text/javascript">
    var disqus_shortname = 'axiac';


    // var disqus_developer = 1;
    var disqus_identifier = 'http://axiac.github.io/blog/merging-git-repositories/';
    var disqus_url = 'http://axiac.github.io/blog/merging-git-repositories/';
    var disqus_script = 'embed.js';

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
  </script>



  <div id="fb-root"></div>
  <script>
    window.fbAsyncInit = function () {
      FB.init({
        appId: '128516770538860',
        xfbml: true,
        version: 'v2.5'
      });
    };

    (function (d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) { return; }
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/sdk.js";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
  </script>



  <script type="text/javascript">
    (function () {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function () {
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  <script type="text/javascript">
    setTimeout(function () {
      var a = document.createElement("script");
      var b = document.getElementsByTagName("script")[0];
      a.src = document.location.protocol + "//script.crazyegg.com/pages/scripts/0019/4087.js?" + Math.floor(new Date().getTime() / 3600000);
      a.async = true; a.type = "text/javascript"; b.parentNode.insertBefore(a, b);
    }, 1);
  </script>


  <script type="text/javascript" id="inspectletjs">
    window.__insp = window.__insp || [];
    __insp.push(['wid', 1818118537]);
    (function () {
      function __ldinsp() { var insp = document.createElement('script'); insp.type = 'text/javascript'; insp.async = true; insp.id = "inspsync"; insp.src = ('https:' == document.location.protocol ? 'https' : 'http') + '://cdn.inspectlet.com/inspectlet.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(insp, x); }
      if (window.attachEvent) {
        window.attachEvent('onload', __ldinsp);
      } else {
        window.addEventListener('load', __ldinsp, false);
      }
    })();
  </script>



</body>

</html>

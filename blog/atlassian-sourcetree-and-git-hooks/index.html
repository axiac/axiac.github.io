<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!-->
<html class="no-js" lang="en"><!--<![endif]-->

<head>
  <meta charset="utf-8">

  <title>Atlassian SourceTree and Git hooks - axiac@web</title>
  <meta name="author" content="axiac">


  <meta name="description" content="This article explains how I made Sismo work with Atlassian SourceTree on OSX. First I thought it doesn&rsquo;t work
out-of-the-box because of a $ &hellip;">


  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <link rel="canonical" href="http://axiac.github.io/blog/atlassian-sourcetree-and-git-hooks/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="axiac@web" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js" async></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript" async></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <script>
      (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
          (i[r].q = i[r].q || []).push(arguments);
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
          m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m);
      })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-545821-11', 'axiac.ro');
    if (navigator.userAgent.indexOf('axiac') == -1) {
      ga('send', 'pageview');
    }
  </script>






  <meta property="fb:app_id" content="128516770538860" />


  <meta property="og:url" content="http://axiac.github.io/blog/atlassian-sourcetree-and-git-hooks/" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Atlassian SourceTree and Git hooks - axiac@web" />
  <meta property="og:description" content="This article explains how I made Sismo work with Atlassian SourceTree on OSX. First I thought it doesn&rsquo;t work
out-of-the-box because of a $PATH problem but soon it turned out that the biggest issue comes from the command line
used for integration. Keep reading to learn how I found it out and &hellip;" />
  <meta property="og:image" content="http://axiac.github.io/favicon.png" />

  <meta property="og:author" content="https://www.facebook.com/axiac.ro/" />



</head>

<body>
  <header role="banner">
    <hgroup>
      <h1><a href="/">axiac@web</a></h1>

    </hgroup>

  </header>
  <nav role="navigation">
    <ul class="subscription" data-subscription="rss">
      <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>

    </ul>

    <form action="https://www.google.com/search" method="get">
      <fieldset role="search">
        <input type="hidden" name="q" value="site:axiac.ro" />
        <input class="search" type="text" name="q" results="0" placeholder="Search" />
      </fieldset>
    </form>

    <ul class="main-navigation">
      <li><a href="/">Blog</a></li>
      <li><a href="/blog/archives">Archives</a></li>
    </ul>

  </nav>
  <div id="main">
    <div id="content">
      <div>
        <article class="hentry" role="article">

          <header>


            <h1 class="entry-title">Atlassian SourceTree and Git hooks</h1>


            <p class="meta">





              <time class='updated' datetime='2016-04-18T15:56:40+03:00'><span class='date'><span class='date-month'>Apr</span> <span
                    class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span></time>

            </p>

          </header>


          <div class="entry-content">
            <p><img src="/images/blog/sismo-sourcetree.png" alt="" style="float: right; margin-left: 50px;" />
              This article explains how I made <code>Sismo</code> work with Atlassian <code>SourceTree</code> on <code>OSX</code>. First I thought it
              doesn&rsquo;t work
              out-of-the-box because of a <code>$PATH</code> problem but soon it turned out that the biggest issue comes from the command line
              used for integration. Keep reading to learn how I found it out and how easy is to fix it.</p>

            <!-- more -->


            <h3>The actors</h3>

            <p><strong><a href="http://sourcetreeapp.com">Atlassian SourceTree</a></strong> is a GUI for Git and Mercurial that runs on Windows and OSX. It
              covers most of the basic VCS
              workflow; it provides a handy button that opens a command line console in the work tree directory, allowing the user
              to type the advanced commands it doesn&rsquo;t provide. All in all, it is a good tool for the daily needs of any developer
              regarding the source code versioning.</p>

            <p><strong><a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">Git hooks</a></strong> are a nice way to enhance the behaviour of Git.
              The pre-commit hooks can be used
              to verify the shape of the code before committing the changes (can run the tests, verify the formatting etc).
              The post-commit hook can be used to send notification emails, to trigger project builds on the continuous
              integration server and so on.</p>

            <p><strong><a href="http://sismo.sensiolabs.org">Sismo</a></strong> is a <em>continuous testing server</em> published by Fabien Potencier (the
              creator of <a href="http://symfony.com">Symfony</a>).
              It is small (everything is packed in a single PHP file that can run both as CLI and as web page), it is fast
              and dumb-easy to configure.</p>

            <h3>The play</h3>

            <p>I&rsquo;m working with Git and SourceTree for years. Sismo joined the group last week and making it work standalone
              was <a href="http://www.quotationspage.com/quote/237.html">as easy as taking candy from a baby</a>. I created a project and put
              <code>composer; phpunit</code> in the list of
              commands to be run by <code>Sismo</code> when I ask it to build the project.</p>

            <p>The next step was to install it as a <code>post-commit</code> hook, in order to run it every time I create a new commit.
              The <a href="http://sismo.sensiolabs.org">Sismo project page</a> explains how to integrate it into the Git workflow by launching it<a
                href="#note1"><sup>1</sup></a>
              from the <code>post-commit</code> git hook:</p>

            <figure class='code'>
              <figcaption><span>.git/hooks/post-commit </span></figcaption>
              <div class="highlight">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre>
                    </td>
                    <td class='code'>
                      <pre><code class='sh'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'>php /path/to/sismo.php --quiet build symfony-local <span class="sb">`</span>git log -1 HEAD --pretty<span class="o">=</span><span class="s2">&quot;%H&quot;</span><span class="sb">`</span> <span class="p">&amp;</span>
</span></code></pre>
                    </td>
                  </tr>
                </table>
              </div>
            </figure>


            <hr />

            <p><a name="note1"><sup>1</sup></a> At the time of this writing, the command displayed on the project&rsquo;s page
              incorrectly escapes the backticks, making <code>Sismo</code> reject it because the incorrect number of arguments.
              I posted it here in the correct form (that runs). It&rsquo;s possible that it was fixed in the meantime in the
              official documentation too.</p>

            <h3>The intrigue</h3>

            <p>It works well when I use Git from the command line. However, it fails with <code>command not found</code> errors
              when I commit using SourceTree. Putting <code>echo $PATH</code> as the first command for the project
              in <code>~/.sismo/config.php</code> revealed that it cannot find <code>composer</code> because it is not in the path known by
              SourceTree. This happens because SourceTree uses the system environment while the environment of my
              <code>bash</code> command line (and of the programs launched by it) is enhanced with paths and aliases in <code>~/.bashrc</code>.
            </p>

            <h3>One (partial) resolution</h3>

            <p>In order to debug the problem easier and get a solution that can be applied to all my projects easily,
              I moved the code from <code>.git/hooks/post-commit</code> into a separate script (I named it <code>sismo-git-post-commit</code>).
              This way, the Git post-commit hook contains a simple call of this external script that receives the Sismo
              project name as argument. All the setup needed to make Sismo work when it is invoked through SourceTree
              (and all future corrections and improvements) require changing a single file (and not every project).</p>

            <p>Since <code>~/.bashrc</code> is read only by <code>bash</code> I had to explicitly call <code>Sismo</code> through <code>bash</code>. This can be
              done
              by prependind the above Sismo command line with <code>bash</code>. It still doesn&rsquo;t work this way because, as <code>man bash</code>
              states:</p>

            <blockquote>
              <p>When <code>bash</code> is started non-interactively, to run a shell script, for example,
                it looks for the variable <code>BASH_ENV</code> in the environment, expands its value if it appears there, and
                uses the expanded value as the name of a file to read and execute.</p>
            </blockquote>

            <p>I modified <code>bin/sismo-git-post-commit</code> to launch <code>Sismo</code> using <code>bash</code> and provide it the correct path to
              <code>.bashrc</code>
              in <code>BASH_ENV</code>:</p>

            <figure class='code'>
              <figcaption><span>~/bin/sismo-git-post-commit </span></figcaption>
              <div class="highlight">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre class="line-numbers"><span class='line-number'>9</span>
</pre>
                    </td>
                    <td class='code'>
                      <pre><code class='sh'><span class='line'><span class="nv">BASH_ENV</span><span class="o">=</span>~/.bashrc bash ~/bin/sismo --quiet build <span class="nv">$PROJECT</span> <span class="k">$(</span>git log -1 HEAD --pretty<span class="o">=</span><span class="s2">&quot;%H&quot;</span><span class="k">)</span> <span class="p">&amp;</span>
</span></code></pre>
                    </td>
                  </tr>
                </table>
              </div>
            </figure>


            <p><em>(If you have noticed that <code>$PROJECT</code> is undefined then please also notice that this is line #9 of the script.
                I have chosen to show only the relevant part here. Keep reading for the complete script.)</em></p>

            <p>It was still working fine using the command line <code>git</code> and it started working when I committed the code
              using <code>SourceTree</code>. It seemed I solved the problem and it was the time to move on.</p>

            <p>But something wasn&rsquo;t working as it used to work before. Committing using <code>SourceTree</code> used to complete in
              a snap. Now it seemed sluggish. And it felt like this because <strong>it was</strong> sluggish.</p>

            <h3>Further investigation</h3>

            <p>I suspected that, even if Sismo runs in the background, for some reason SourceTree waits until it completes.
              It&rsquo;s not Git the one that produces the delay; it worked fine when I used <code>git commit</code> from the command line.</p>

            <p>The execution of <code>sismo build</code> takes some time, depending on the size of the project and the commands used
              to build it. Mine were pretty light, that&rsquo;s why I added <code>sleep 5</code> as the first build command for the project.
              The next two commits, one from the command line, the other using <code>SourceTree</code> revealed the truth: SourceTree
              indeed waits for the <code>sismo</code> command to complete before it closes the &ldquo;Committing&rdquo; console. The command line
              <code>git commit</code> still completes in a snap, without any additional delay.
            </p>

            <p>I scratched my head and suddenly it dawned to me: when it launches Git in the background to process the commit,
              SourceTree connects to Git&rsquo;s standard output through a pipe in order to get and display in the &ldquo;Committing&rdquo;
              console whatever output Git might produce. Git launches the hook, the hook launches <code>sismo</code> in background but
              none of them close their <code>stdout</code> (they don&rsquo;t have any reason to do it) and because of inheritance, all
              their standard output streams remain connected with SourceTree through the pipe.</p>

            <p>Even if <code>sismo-git-post-commit</code> doesn&rsquo;t produce any output (the <code>--quiet</code> option of <code>sismo</code> takes care of
              that),
              the pipe remains open until all the processes attached to it on the other end complete. SourceTree remains
              connected to it, dutifully waiting for some <code>git</code> output to present to the user.</p>

            <p>To verify this assumption I replaced <code>--quiet</code> with <code>--verbose</code> (to force <code>sismo</code> produce a lot of output)
              and I configured SourceTree to always open the console when it runs the Git commands in background and
              <em>voilà!</em> All the output produced by <code>sismo</code> is there, after the 5 seconds delay.
            </p>

            <h3>The epilogue</h3>

            <p>At this point, everything was clear and the fix was straight forward. After I removed all the debug code
              all I had to do was to disconnect from the pipe the <code>stdout</code> and <code>stderr</code> of the <code>sismo</code> instance
              launched in background. This can be easily accomplished by redirecting them to <code>/dev/null</code>.</p>

            <p>The commit hook and the script it uses now look like this:</p>

            <figure class='code'>
              <figcaption><span>.git/hooks/post-commit </span></figcaption>
              <div class="highlight">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre>
                    </td>
                    <td class='code'>
                      <pre><code class='sh'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'>~/bin/sismo-git-post-commit project-name <span class="p">&amp;</span>
</span></code></pre>
                    </td>
                  </tr>
                </table>
              </div>
            </figure>




            <figure class='code'>
              <figcaption><span>~/bin/sismo-git-post-commit </span></figcaption>
              <div class="highlight">
                <table>
                  <tr>
                    <td class="gutter">
                      <pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre>
                    </td>
                    <td class='code'>
                      <pre><code class='sh'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="nv">PROJECT</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$PROJECT&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;Missing project name.&quot;</span>
</span><span class='line'>    <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nv">BASH_ENV</span><span class="o">=</span>~/.bashrc bash ~/bin/sismo --quiet build <span class="nv">$PROJECT</span> <span class="k">$(</span>git log -1 HEAD --pretty<span class="o">=</span><span class="s2">&quot;%H&quot;</span><span class="k">)</span> &gt;/dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span>
</span></code></pre>
                    </td>
                  </tr>
                </table>
              </div>
            </figure>


            <h3>Remarks</h3>

            <p>A very helpful tool for debugging the problem was the shell redirection of standard output (and error) streams
              of the <code>sismo</code> command to a file. Together with the <code>--verbose</code> option it allowed me to see what happened
              under the hood when the things doesn&rsquo;t work as expected (in the first part).</p>
          </div>


          <footer>
            <p class="meta">



              <span class="byline author vcard">Posted by <span class="fn">axiac</span></span>






              <time class='updated' datetime='2016-04-18T15:56:40+03:00'><span class='date'><span class='date-month'>Apr</span> <span
                    class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span></time>


              <span class="categories">

                <a class='category' href='/blog/categories/git/'>git</a>, <a class='category' href='/blog/categories/osx/'>osx</a>

              </span>


            </p>

            <div class="sharing">

              <a href="//twitter.com/share" class="twitter-share-button" data-url="http://axiac.github.io/blog/atlassian-sourcetree-and-git-hooks/"
                data-via="axiac" data-counturl="http://axiac.github.io/blog/atlassian-sourcetree-and-git-hooks/">Tweet</a>


              <div class="g-plusone" data-size="medium"></div>


              <div class="fb-like" data-share="true" data-width="450" data-show-faces="false"></div>

            </div>


            <div class="fb-comments" data-href="http://axiac.github.io/blog/atlassian-sourcetree-and-git-hooks/" data-numposts="5" data-width="789"></div>



            <p class="meta">

              <a class="basic-alignment left" href="/blog/distinct-with-rollup/" title="Previous Post: DISTINCT vs. GROUP BY WITH ROLLUP">&laquo; DISTINCT vs.
                GROUP BY WITH ROLLUP</a>


              <a class="basic-alignment right" href="/blog/public-properties-are-not-oop/" title="Next Post: Public properties are not OOP">Public properties
                are not OOP &raquo;</a>

            </p>
          </footer>
        </article>

        <section>
          <h1>Comments</h1>
          <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered
                by Disqus.</a></noscript>
          </div>
        </section>

      </div>

      <aside class="sidebar">

        <section>
          <h1>Recent Posts</h1>
          <ul id="recent_posts">


            <li class="post">
              <a href="/blog/why-is-mysql-time-limited-to-838-59-59/">Why Is MySQL Time Limited to 838:59:59?</a>
            </li>


            <li class="post">
              <a href="/blog/git-ignores-me-not-my-files/">Git Ignores Me, Not My Files</a>
            </li>


            <li class="post">
              <a href="/blog/how-to-merge-composer-files/">How to Merge Composer Files</a>
            </li>


            <li class="post">
              <a href="/blog/public-properties-are-not-oop/">Public Properties Are Not OOP</a>
            </li>


            <li class="post">
              <a href="/blog/atlassian-sourcetree-and-git-hooks/">Atlassian SourceTree and Git hooks</a>
            </li>

          </ul>
        </section>



        <section class="googleplus googleplus-hidden">
          <h1>
            <a href="https://plus.google.com/116025233500446558681?rel=author">
              <img src="//www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
              Google+
            </a>
          </h1>
        </section>




      </aside>


    </div>
  </div>
  <footer role="contentinfo">
    <p>
      Copyright &copy; 2013-2020 - axiac -
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
    </p>

  </footer>


  <script type="text/javascript">
    var disqus_shortname = 'axiac';


    // var disqus_developer = 1;
    var disqus_identifier = 'http://axiac.github.io/blog/atlassian-sourcetree-and-git-hooks/';
    var disqus_url = 'http://axiac.github.io/blog/atlassian-sourcetree-and-git-hooks/';
    var disqus_script = 'embed.js';

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
  </script>



  <div id="fb-root"></div>
  <script>
    window.fbAsyncInit = function () {
      FB.init({
        appId: '128516770538860',
        xfbml: true,
        version: 'v2.5'
      });
    };

    (function (d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) { return; }
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/sdk.js";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
  </script>



  <script type="text/javascript">
    (function () {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function () {
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





  <script type="text/javascript">
    setTimeout(function () {
      var a = document.createElement("script");
      var b = document.getElementsByTagName("script")[0];
      a.src = document.location.protocol + "//script.crazyegg.com/pages/scripts/0019/4087.js?" + Math.floor(new Date().getTime() / 3600000);
      a.async = true; a.type = "text/javascript"; b.parentNode.insertBefore(a, b);
    }, 1);
  </script>


  <script type="text/javascript" id="inspectletjs">
    window.__insp = window.__insp || [];
    __insp.push(['wid', 1818118537]);
    (function () {
      function __ldinsp() { var insp = document.createElement('script'); insp.type = 'text/javascript'; insp.async = true; insp.id = "inspsync"; insp.src = ('https:' == document.location.protocol ? 'https' : 'http') + '://cdn.inspectlet.com/inspectlet.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(insp, x); }
      if (window.attachEvent) {
        window.attachEvent('onload', __ldinsp);
      } else {
        window.addEventListener('load', __ldinsp, false);
      }
    })();
  </script>



</body>

</html>
